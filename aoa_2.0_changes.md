# Android Open Accessory (AOA) 2.0 프로토콜 분석 및 가이드

이 문서는 Android Open Accessory (AOA) 1.0 사양을 바탕으로 2.0에서 추가된 변경사항과 1.0 구현 시 수정/고려해야 할 사항을 정리한 가이드입니다.

---

## 1. AOAv2 주요 변경사항

AOAv2는 기존 AOAv1의 기능을 모두 포함하면서, 액세서리가 Android 운영체제 자체와 직접 상호작용할 수 있는 강력한 기능들을 추가했습니다.

### ① 오디오 출력 (Audio Output) 지원
- **기능**: Android 기기의 오디오를 액세서리(예: 오디오 도크)를 통해 출력할 수 있습니다.
- **사양**: 2채널, 16비트 PCM, 44100Hz 비트 전송률의 표준 USB 오디오 클래스 인터페이스를 사용합니다.
- **활성화**: `ACCESSORY_START` 명령어를 보내기 전에 `SET_AUDIO_MODE` 제어 요청(Request 58)을 먼저 전송해야 합니다.
  > [!WARNING]
  > Android 8.0(Oreo)부터는 AOA를 통한 오디오 출력 지원이 중단되었으므로, 최신 기기 대응 시 주의가 필요합니다.

### ② HID(Human Interface Device) 기능 추가
- **기능**: 액세서리가 Android 기기에 키보드, 마우스, 게임 컨트롤러 등의 입력 장치로 등록될 수 있습니다.
- **특징**: 기존 USB HID와 달리, USB 호스트(액세서리)가 USB 주변기기(Android)에 이벤트를 보내는 방식으로 동작합니다.
- **새로운 제어 요청**:
  - `ACCESSORY_REGISTER_HID` (54): 새로운 HID 장치 등록
  - `ACCESSORY_UNREGISTER_HID` (55): 등록된 HID 장치 제거
  - `ACCESSORY_SET_HID_REPORT_DESC` (56): HID 보고서 설명어(Report Descriptor) 전송
  - `ACCESSORY_SEND_HID_EVENT` (57): 실제 입력 이벤트 데이터 전송

### ③ 새로운 USB 제품 ID(PID) 도입
AOAv2는 지원하는 인터페이스 조합에 따라 다양한 PID를 사용합니다.
- `0x2D02`: 액세서리 + 오디오
- `0x2D03`: 액세서리 + 오디오 + ADB
- `0x2D04`: 액세서리 + HID
- `0x2D05`: 액세서리 + HID + ADB
- *`0x2D00`(액세서리 전용) 및 `0x2D01`(액세서리 + ADB)은 계속 지원됩니다.*

---

## 2. AOA 1.0에서 수정 및 보완해야 할 사항

AOA 1.0 기반 시스템을 2.0으로 업데이트하거나 최신 기기에서 안정적으로 동작시키기 위해 다음 사항들을 확인해야 합니다.

### ① 프로토콜 버전 확인 로직 개선
- **수정 사항**: `getProtocol()` 요청 시 1.0은 `1`, 2.0은 `2`를 반환합니다. 
- **권장 사항**: 단순히 `protocol == 1`로 확인하던 로직을 `protocol >= 1`로 수정하여 상위 버전과의 호환성을 확보하세요.

### ② 인터페이스 선택 로직 강화 (PID 처리)
- **문제점**: 1.0은 PID가 0x2D00, 0x2D01 두 가지만 고려하면 되었으나, 2.0에서는 오디오/HID 포함 여부에 따라 PID가 다양해졌습니다.
- **수정 사항**: 
  - 특정 PID만 체크하는 방식 대신, Android 기기가 액세서리 모드로 전환된 후의 PID(0x2D00 ~ 0x2D05)를 모두 인지할 수 있도록 범위를 넓혀야 합니다.
  - 특히 ADB가 포함된 PID(0x2D01, 0x2D03, 0x2D05)의 경우, 대량 전송(Bulk) 엔드포인트를 가진 첫 번째 인터페이스가 앱 통신 채널임을 정확히 식별해야 합니다.

### ③ 앱 실행 유도(App Launch) 제어
- **변경 사항**: AOAv2에서는 Android 앱 없이도 오디오나 HID 기능을 사용할 수 있습니다.
- **최적화**: 만약 액세서리가 특정 앱과 통신할 필요가 없다면(예: 단순 오디오 도크), 제조사(Manufacturer)와 모델(Model) 문자열을 보내지 않음으로써 사용자에게 "앱 연결 대화상자"가 뜨지 않게 제어할 수 있습니다.

### ④ 하위 호환성 유지
- **핵심**: AOAv2는 AOAv1과 하위 호환되도록 설계되었습니다. 1.0 액세서리라도 `ACCESSORY_START` 과정을 올바르게 수행한다면 2.0 지원 기기에서도 기본 기능(앱 통신)은 문제없이 작동해야 합니다.

---

## 3. AOAv2 연결 프로세스 체크리스트

액세서리(Host) 단에서 다음 순서로 구현되었는지 확인하세요.

1.  **장치 감지**: 연결된 장치가 Android 기기인지 확인.
2.  **프로토콜 확인**: `getProtocol()`을 보내 `1` 또는 `2`를 수신.
3.  **데이터 전송 (선택)**: 제조사, 모델, 버전 등 식별 문자열 전송.
4.  **모드 설정 (AOAv2 전용)**:
    - 오디오 사용 시 `SET_AUDIO_MODE` 전송.
    - HID 사용 시 장치 등록 및 리포트 설명어 전송.
5.  **모드 전환**: `ACCESSORY_START`를 보내 Android 기기를 액세서리 모드로 전환.
6.  **인터페이스 재구성**: 변경된 PID에 맞춰 USB 핸들과 엔드포인트를 다시 열기.

---

> [!TIP]
> **Android SDK API** 측면에서는 앱 개발자가 사용하는 클래스(`UsbManager`, `UsbAccessory`)에 큰 변화가 없으므로, 기존의 앱 로직은 대부분 그대로 유지할 수 있습니다. 주요 변경 사항은 USB 통신을 직접 제어하는 **액세서리 기기(Host) 측 하드웨어/펌웨어**에 적용됩니다.
